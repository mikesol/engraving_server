<!DOCTYPE html>
<html>
  <head>
    <title>
      Engraving server test
    </title>
    <style type="text/css" src="fonts/stylesheet.css"></style>
    <script src="jquery-1.11.1.min.js" type="text/javascript"></script>
    <script type="text/javascript">
      var WS = new WebSocket("ws://localhost:8000");
      WS.onopen = function() {
        out = []
        append_standard_graphical_queries(out);
        WS.send(JSON.stringify(out));
      }
      function s_(v) {
        return 4.0 * v;
      }
      function st_x(v) {
        return s_(v) + 30;
      }
      function st_y(v) {
        return s_(v) + 30;
      }
      var PREV = 8;
      var PREV_PREV = 7;
      var GLOBAL_NOTE_ADD_KLUDGE = 10;
      function build_simple_insert(table, dct) {
        console.log(table, dct);
        var keys = []
        for (var key in dct) {
          keys.push(key)
        }
        var stmt = "INSERT INTO "+table+" ("
        stmt += keys.join();
        stmt += ") VALUES ("
        var vals = [];
        for (var i = 0 ; i < keys.length; i++) {
          vals.push(dct[keys[i]]);
        }
        stmt += vals.join();
        stmt += ");"
        return stmt;
      }
      function addNote() {
        out = []
        out.push({
          expected : [],
          sql : "DELETE FROM graphical_next WHERE graphical_next.id = "+PREV+";" 
        });
        out.push({
          expected : [],
          sql: "INSERT INTO graphical_next (id, prev, next) VALUES("+PREV+","+PREV_PREV+","+GLOBAL_NOTE_ADD_KLUDGE+");"
        });
        out.push({
          expected : [],
          sql: "INSERT INTO graphical_next (id, prev, next) VALUES("+GLOBAL_NOTE_ADD_KLUDGE+","+PREV+",NULL);"
        });
        out.push({
          expected : [],
          sql : build_simple_insert('name',{id:GLOBAL_NOTE_ADD_KLUDGE, val :
          "'note'"})
        });
        out.push({
          expected : [],
          sql : build_simple_insert('font_name',{id:GLOBAL_NOTE_ADD_KLUDGE,
          val : "'Bravura'"})
        });
        out.push({
          expected : [],
          sql : build_simple_insert('font_size',{id:GLOBAL_NOTE_ADD_KLUDGE, val : 20})
        });
        out.push({
          expected : [],
          sql : build_simple_insert('duration_log',{id:GLOBAL_NOTE_ADD_KLUDGE,
          val : -3})
        });
        out.push({
          expected : [],
          sql : build_simple_insert('staff_symbol',{id:GLOBAL_NOTE_ADD_KLUDGE,
          val : 9})
        });
        PREV_PREV = PREV;
        PREV = GLOBAL_NOTE_ADD_KLUDGE;
        GLOBAL_NOTE_ADD_KLUDGE += 1;
        
        append_standard_graphical_queries(out);
        ///////////////////////////
        WS.send(JSON.stringify(out));
      }
      function table_to_columns(name) {
        if (name == "line_stencil") {
          return "line_stencil.id, line_stencil.x0, line_stencil.y0, line_stencil.x1, line_stencil.y1, line_stencil.thickness";
        } else if (name == "glyph_stencil") {
          return "glyph_stencil.id, glyph_stencil.font_name, glyph_stencil.font_size, glyph_stencil.unicode, glyph_stencil.x, glyph_stencil.y";
        }
      }
      function stencil_sql_request(name) {
        var out = "SELECT " + table_to_columns(name) + ", x_position.val, y_position.val FROM " + name + " LEFT JOIN x_position ON " + name + ".id = x_position.id LEFT JOIN y_position ON " + name + ".id = y_position.id";
        return out + ";"
      }
      function append_standard_graphical_queries(out) {
        out.push({
          name : 'line_stencil',
          expected : ['id', 'x0', 'y0',
          'x1', 'y1', 'thickness',
          'x_position', 'y_position'],
          sql : stencil_sql_request('line_stencil')
        });
        out.push({
          name : 'glyph_stencil',
          expected : ['id', 'font_name', 'font_size',
          'unicode', 'x', 'y',
          'x_position', 'y_position'],
          sql : stencil_sql_request('glyph_stencil')
        });
      }
      WS.onmessage = function(evt) {
        console.log(evt.data);
        json = eval("("+evt.data+")");
        console.log(json);
        var canvas = $("#engraving")[0];
        var context = canvas.getContext('2d');
        context.clearRect(0,0,canvas.width, canvas.height);
        for (var i = 0; i < json.line_stencil.length; i++) {
          var line = json.line_stencil[i];
          //console.log("making line", line);
          context.beginPath();
          var x = line['x_position'] ? line['x_position'] : 0.0;
          var y = line['y_position'] ? line['y_position'] : 0.0;
          context.moveTo(st_x(line['x0'] + x), st_y(line['y0'] + y));
          context.lineTo(st_y(line['x1'] + x), st_y(line['y1'] + y));
          context.lineWidth = s_(line['thickness']);
          console.log("LW", context.lineWidth);
          context.stroke();
        }
        for (var i = 0; i < json.glyph_stencil.length; i++) {
          var glyph = json.glyph_stencil[i];
          var x = glyph['x'] + (glyph['x_position'] ? glyph['x_position'] : 0.0);
          var y = glyph['y'] + (glyph['y_position'] ? glyph['y_position'] : 0.0);
          context.font = 'normal '+glyph['font_size']+'px '+glyph['font_name'];
          uc = String.fromCharCode(parseInt(glyph['unicode'].substr(2), 16));
          //console.log(context.font, glyph[3], uc);
          context.fillText(uc, st_x(x), st_y(y));
        }
      }
      $(document).ready(function() {
      });
    </script>
  </head>
  <body>
    <canvas id="engraving" width="1000" height="300">
    </canvas>
    <div onclick="addNote()">click on me to add a note</div>
  </body>
</html>
