<!DOCTYPE html>
<html>
  <head>
    <title>
      Engraving server test
    </title>
    <style type="text/css" src="fonts/stylesheet.css"></style>
    <script src="jquery-1.11.1.min.js" type="text/javascript"></script>
    <script type="text/javascript">
      var WS = new WebSocket("ws://localhost:8000");
      var GLOBAL_NOTE = 0;
      var GLOBAL_OCTAVE = -1;
      function addNoteN(v) {
        GLOBAL_NOTE = v;
        addNote_1();
      }
      function changeOctave(v) {
        GLOBAL_OCTAVE += v;
      }
      function makeid() {
        var text = "";
        var possible =
              "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

        for( var i=0; i < 8; i++ ) {
          text += possible.charAt(Math.floor(Math.random() *
          possible.length));
        }

        return text;
      }
      function _be(s) {
        return "^"+s+"$"
      }
      var MY_NAME = makeid();
      WS.onopen = function() {
        out = []
        append_standard_graphical_queries(out);
        out = {client:MY_NAME, sql:out, 'return': _be(MY_NAME), subsequent:"draw"};
        WS.send(JSON.stringify(out));
      }
      function s_(v) {
        return 4.0 * v;
      }
      function st_x(v) {
        return s_(v) + 30;
      }
      function st_y(v) {
        return s_(v) + 30;
      }
      function build_simple_insert(table, dct) {
        //console.log(table, dct);
        var keys = []
        for (var key in dct) {
          keys.push(key)
        }
        var stmt = "INSERT INTO "+table+" ("
        stmt += keys.join();
        stmt += ") VALUES ("
        var vals = [];
        for (var i = 0 ; i < keys.length; i++) {
          vals.push(dct[keys[i]]);
        }
        stmt += vals.join();
        stmt += ");"
        return stmt;
      }
      function increment_last_used_item() {
          return "INSERT INTO used_ids (id) SELECT max(used_ids.id) + 1 FROM used_ids;";
      }
      function get_last_used_item() {
          return "SELECT max(used_ids.id) FROM used_ids;";
      }
      function addNote_1() {
        var out = [];
        out.push({
          expected : [],
          sql : increment_last_used_item()
        });
        out.push({
          name : 'next',
          expected : ['id'],
          sql : get_last_used_item()
        });
        out.push({
          name : 'prev',
          expected : ['id'],
          sql : "SELECT graphical_next.id FROM graphical_next WHERE graphical_next.next IS NULL;"
        });
        out.push({
          name : 'prev_prev',
          expected : ['id'],
          sql : "SELECT graphical_next.prev FROM graphical_next WHERE graphical_next.next IS NULL;"
        });
        out = {client:MY_NAME, sql:out, 'return': _be(MY_NAME), subsequent:"addNote_2"};
        WS.send(JSON.stringify(out));
      }
      function addNote_2(data) {
        console.log("data going to AN_2", data);
        out = [];
        var prev = data['prev'][0]['id'];
        var prev_prev = data['prev_prev'][0]['id'];
        var next = data['next'][0]['id'];
        out.push({
          expected : [],
          sql : "DELETE FROM graphical_next WHERE graphical_next.id = "+prev+";" 
        });
        out.push({
          expected : [],
          sql: "INSERT INTO graphical_next (id, prev, next) VALUES("+prev+","+prev_prev+","+next+");"
        });
        out.push({
          expected : [],
          sql: "INSERT INTO graphical_next (id, prev, next) VALUES("+next+","+prev+",NULL);"
        });
        out.push({
          expected : [],
          sql : build_simple_insert('name',{id:next, val :
          "'note'"})
        });
        out.push({
          expected : [],
          sql : build_simple_insert('font_name',{id:next,
          val : "'Bravura'"})
        });
        out.push({
          expected : [],
          sql : build_simple_insert('font_size',{id:next, val : 20})
        });
        out.push({
          expected : [],
          sql : build_simple_insert('duration_log',{id:next,
          val : -3})
        });
        out.push({
          expected : [],
          sql : build_simple_insert('staff_symbol',{id:next,
          val : 9})
        });
        out.push({
          expected : [],
          sql : build_simple_insert('pitch',{id:next,
          val : GLOBAL_NOTE})
        });
        out.push({
          expected : [],
          sql : build_simple_insert('octave',{id:next,
          val : GLOBAL_OCTAVE})
        });
        
        append_standard_graphical_queries(out);
        out = {client:MY_NAME, sql:out, 'return': "*", subsequent: "draw"};
        ///////////////////////////
        WS.send(JSON.stringify(out));
      }
      function table_to_columns(name) {
        if (name == "line_stencil") {
          return "line_stencil.id, line_stencil.x0, line_stencil.y0, line_stencil.x1, line_stencil.y1, line_stencil.thickness";
        } else if (name == "glyph_stencil") {
          return "glyph_stencil.id, glyph_stencil.font_name, glyph_stencil.font_size, glyph_stencil.unicode, glyph_stencil.x, glyph_stencil.y";
        }
      }
      function stencil_sql_request(name) {
        var out = "SELECT " + table_to_columns(name) + ", x_position.val, y_position.val FROM " + name + " LEFT JOIN x_position ON " + name + ".id = x_position.id LEFT JOIN y_position ON " + name + ".id = y_position.id";
        return out + ";"
      }
      function append_standard_graphical_queries(out) {
        out.push({
          name : 'line_stencil',
          expected : ['id', 'x0', 'y0',
          'x1', 'y1', 'thickness',
          'x_position', 'y_position'],
          sql : stencil_sql_request('line_stencil')
        });
        out.push({
          name : 'glyph_stencil',
          expected : ['id', 'font_name', 'font_size',
          'unicode', 'x', 'y',
          'x_position', 'y_position'],
          sql : stencil_sql_request('glyph_stencil')
        });
      }
      WS.onmessage = function(evt) {
        //console.log(evt.data);
        //var json = eval("("+evt.data+")");
        //console.log(json);
        json = eval("("+evt.data+")")
        var subsequent = json['subsequent'];
        console.log("subs", json['subsequent']);
        if (subsequent) {
          eval(subsequent+"("+evt.data+")");
        }
      }
      function draw(data) {
        console.log("data going to draw", data)
        var canvas = $("#engraving")[0];
        var context = canvas.getContext('2d');
        context.clearRect(0,0,canvas.width, canvas.height);
        for (var i = 0; i < data.line_stencil.length; i++) {
          var line = data.line_stencil[i];
          console.log("making line", line);
          context.beginPath();
          var x = line['x_position'] ? line['x_position'] : 0.0;
          var y = line['y_position'] ? line['y_position'] : 0.0;
          context.moveTo(st_x(line['x0'] + x), st_y(line['y0'] + y));
          context.lineTo(st_y(line['x1'] + x), st_y(line['y1'] + y));
          context.lineWidth = s_(line['thickness']);
          console.log("LW", context.lineWidth);
          context.stroke();
        }
        for (var i = 0; i < data.glyph_stencil.length; i++) {
          var glyph = data.glyph_stencil[i];
          var x = glyph['x'] + (glyph['x_position'] ? glyph['x_position'] : 0.0);
          var y = glyph['y'] + (glyph['y_position'] ? glyph['y_position'] : 0.0);
          context.font = 'normal '+glyph['font_size']+'px '+glyph['font_name'];
          uc = String.fromCharCode(parseInt(glyph['unicode'].substr(2), 16));
          //console.log(context.font, glyph[3], uc);
          context.fillText(uc, st_x(x), st_y(y));
        }
      }
      $(document).ready(function() {
      });
    </script>
  </head>
  <body>
    <canvas id="engraving" width="1000" height="300">
    </canvas>
    <div onclick="addNoteN(0)">click on me to add a C</div>
    <div onclick="addNoteN(1)">click on me to add a D</div>
    <div onclick="addNoteN(2)">click on me to add a E</div>
    <div onclick="addNoteN(3)">click on me to add a F</div>
    <div onclick="addNoteN(4)">click on me to add a G</div>
    <div onclick="addNoteN(5)">click on me to add a A</div>
    <div onclick="addNoteN(6)">click on me to add a B</div>
    <div onclick="addNoteN(6)">click on me to add a B</div>
    <div onclick="changeOctave(-1)">click on me to drop the octave</div>
    <div onclick="changeOctave(1)">click on me to raise the octave</div>
  </body>
</html>
